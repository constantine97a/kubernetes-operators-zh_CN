# Operator Philosophy
[TOC]

我们已经注意到Operator旨在解决的问题，您已经通过了如何使用SDK构建Operator的详细示例。
您还看到了如何使用OLM以一致的方式分发Operator。让我们试着将这些策略与支撑它们理解一个存在主义问题的战略理念联系起来：Operator到底支持什么？Operator概念源自现场可靠性工程(SRE)。
回到第一章中，我们将Operator讨论为软件SREs。让我们回顾一下一些关键的SRE原则，以了解Operator是如何应用它们。

## SRE for Every Application

SRE始于谷歌，以应对运行拥有越来越多用户和功能的大型系统的挑战。
SRE的一个关键目标是允许服务部门的增长，而不迫使管理它们的团队成正比增长。为了在没有大规模团队的情况下以大规模运行系统，SREs需要编写代码来处理部署、操作和维护任务。
SREs创建一个可以运行其他软件的软件，保持它的运行，并长期管理它。
SRE是一套以自动化为中心原则的更广泛的管理和工程技术。你可能听说过它的目标有不同的名字，比如“自动驾驶”或“自动驾驶”软件。
在我们在图4-1中介绍的Operator成熟度模型中，我们称之为“自动领航”(Auto Pilot)。


Operator和Operator框架使得在库伯特上运行的应用程序更容易实现这种自动化。Kubernetes协调服务部署，使无状态应用程序自动完成一些水平扩展或故障恢复的工作。
它将分布式系统资源表示为API抽象。通过使用Operator，开发人员可以将这些实践扩展到复杂的应用程序中。


著名的“SRE书”网站可靠性工程(O‘Reilly)，由BetsyBeyer等人编著,是关于SRE原则的权威指南。
谷歌工程师Carla Geisser的评论代表了SRE的自动化元素：
“如果人类Operator在正常操作过程中需要触摸你的系统，你就有一个错误。“ SREs编写代码来修复这些错误。Operator是一个合乎逻辑的编程修复一个广泛的应用程序的地方。Operator通过自动匹配使其应用程序继续运行的常规杂务来减少
人工干预的错误

## Toil Not, Neither Spin(不旋转，不旋转)

SRE试图通过创建软件来执行操作系统所需的任务来减少辛劳。在这种情况下，Toil被定义为“可自动化的、战术的、缺乏持久价值，并且随着服务的增长而线性扩展”。

### 自动化：你的计算机想要的工作

如果机器能做到这一点，工作是可以自动化的。如果一项任务需要辨别人类的判断，那么机器就做不到。
例如，费用报告需要进行各种机器驱动的边界检查，但通常需要进行一些最终的人工审查——对自动流程标记为越界的项目，如果不是每个收据的话。
在一定范围内的报告的批准可以自动进行；最终接受或拒绝越界的案件不得发生。软件自动化的工作，如果是重复的，应该由软件自动化。
构建软件来执行重复任务的成本可以在重复周期中摊销。

### Running in Place: Work of No Enduring Value （原地运行：无持久值工作）

认为一些工作没有价值可能会感到不舒服，但用SRE的术语来说，如果做工作不能改变服务，工作就“缺乏持久的价值”。
备份一个数据库服务器就是一个例子。数据库不会更快，不会提供更多的请求，或者在备份它时不会变得更可靠。
它也不会停止工作。然而，尽管备份没有持久的价值，但备份显然还是值得一做的。这种工作对Operator来说往往是一份好工作。

### 成长的烦恼：随着系统而扩展的工作

您可以设计一个服务，使其在水平平面上伸缩，以服务更多的请求或运行更多的服务实例。
但是，如果添加一个新实例需要工程师配置计算机并将它们连接到网络，那么扩展服务就不是自动的。
在这种工作的最坏情况下，运维工作可能会与您的服务线性扩展。服务每增长10%——即增加10%的用户，每秒增加10%的请求，或者增加使用10%CPU的新特性——就意味着增加10%的托管劳动力。

#### 手动缩放：就像在过去糟糕的日子里一样
想象一下从第1章开始运行无状态的web服务器。您可以在三个虚拟机上部署三个实例。
要增加更多的Web服务器容量，可以启动新的虚拟机，为它们分配了（唯一的）IP地址，并分配了Web服务器二进制文件侦听的端口。接下来，您将通知负载均衡器新的端点，以便它可以在那里路由一些请求。

按照设计和配置的那样，简单的无状态web服务器可以随需求增长。它可以为更多的用户提供更多的服务，并添加更多的特性。
但运营这项服务的团队总是必须随之发展。随着系统的增大，这种效果会变得更糟，因为添加一个VM并不会有意义地增加1000个实例的容量


#### 自动水平缩放：Kubernetes副本

如果您在Kubernetes上部署无状态web服务器，您可以只用一个kubectl命令来上下缩小它。这是Kubernetes在平台级别上实现SRE的自动化原则的一个例子。Kubernetes抽象了web服务器运行的基础设施以及它们提供连接服务的IP地址和端口。在进行扩展时，您不必配置每个新的web服务器实例，或者在向下扩展时故意从您的应用范围中释放ip。您不必为负载均衡器进行编程来将流量传递到一个新的实例。而是用软件来做这些家务。

## Operator：Kubernetes应用可靠性工程
Operator扩展库伯内，将自动化原则扩展到平台上运行的复杂、状态丰富的应用程序。考虑一个使用自己的集群概念来管理应用程序的Operator。当etcdOperator替换一个失败的etcd集群成员时，它通过配置它和现有的成员。

如果您是一个负责管理内部服务的团队，Operator将帮助您捕捉软件中的专家程序，并扩展系统的“正常操作”：即它可以自动处理的一组条件。如果你正在开发一个Kubernetes的原生应用程序，一个Operator可以让你思考用户如何努力运行你的应用程序，并为他们节省麻烦。您可以构建不仅可以运行和升级应用程序，而且可以响应错误或降低性能的Operator。

Kubernetes中的控制循环监视资源并在它们不匹配期望状态时做出反应。Operator允许您为代表应用程序的资源自定义一个控制循环。Operator首先关心的问题通常是Operator的自动部署和自助服务供应。除了成熟度模型的第一级之外，Operator还应该了解其应用程序的关键状态以及如何修复它。然后，Operator可以扩展到观察关键的应用程序度量，并采取行动来调优、修复或报告它们。

### 管理应用程序状态

应用程序通常具有需要在复制副本之间进行同步或维护的内部状态。一旦Operator处理了安装和部署，它就可以通过保持这些共享状态，沿着成熟度模型移动得更远。任何具有自己的集群概念的应用程序，如许多数据库和文件服务器，都具有这种共享应用程序状态。它可能包括身份验证资源、复制安排或写入器/阅读器关系船。Operator可以为一个新的复制副本配置此共享状态，从而允许它使用新的成员来扩展或恢复应用程序的集群。Operator可能会纠正其应用程序所需要的外部资源。例如，考虑操作外部负载平衡器的路由规则，作为副本模具和新的副本替换它们。



###  发送到软件上的黄金信号
拜尔建议监控“四个黄金信号”3，以获得对一个系统健康状况的最清晰的即时感觉。服务的基本操作的这些特征是开始计划Operator应该注意的内容的好地方。在普及它们的SRE书中，黄金信号传达了一些关于系统状态的重要信息，足以触发对人类工程师的呼叫。4在设计Operator时，你应该把任何可能导致呼叫一个人的事情作为一个你可以解决的错误。


SRE列出了四个黄金信号：延迟、流量、错误和饱和度。对这四个领域的准确测量，适应最能代表特定应用程序状况的指标，确保对应用程序运行状况的合理理解。Operator可以监视这些信号，并在它们描述已知条件、问题或错误时采取特定于应用程序的操作。让我们仔细看看

* 延迟(Latency)
  * 延迟是指做某件事所需的时间。它通常被理解为从请求到完成请求之间所经过的时间。例如，在网络中，延迟是指在两点之间发送数据包所花费的时间。Operator可以测量特定于应用程序的内部延迟，比如游戏客户端中的动作和游戏引擎中的响应之间的延迟时间。
* 流量(Traffic)
  * 流量度量请求服务的频率。每秒一次的HTTP请求是web服务流量的标准度量方法。监控机制通常会将这些度量拆分为静态资产和动态生成的资产。每秒监控数据库或文件服务器事务类的东西更有意义。
* 错误（Errors)
  * 错误是失败的请求，如HTTP500系列错误。在web服务中，您可能有一个HTTP成功代码，但可以在成功交付的页面上看到脚本异常或其他客户端错误。超过某些延迟保证或性能策略也可能是一个错误，比如在一个时间限制内响应任何请求的保证。
* 饱和度(Saturation)
  * 饱和度是衡量服务对有限资源消耗的指标。这些度量集中于系统中最有限的资源，通常是CPU、内存和I/O。在监测饱和度方面有两个关键思想。首先，在资源100%利用之前，性能会变得更糟。例如，有些文件系统在满满超过90%时表现不佳，因为创建文件所需的时间随着可用空间的减少而增加。由于几乎任何系统都有类似的效果，饱和度监测仪通常应该对低于100%的高水位标记做出反应。其次，测量饱和度可以帮助你在一些问题发生之前就预测出它们。将文件服务的空闲空间除以应用程序写入数据的速率，让Operator估计存储满为止的时间。

Operator可以通过测量和响应需要日益复杂操作的黄金信号，在自动试点上运行您的服务。每次应用程序需要人工帮助时，应用此分析，您有一个Operator迭代开发的基本计划。

## 高度成功的Operator的七个习惯
2015年和2016年，Operator孵化与CoreOS。用户体验与Operator在那里建立，并继续在红帽，并在更广泛的社区，帮助完善了七个指导方针，作为Kubernetes Operator的概念固化：
* Operator应该作为单个Kubernetes Deployment运行
  * 您在第2章中从一个清单中安装了etcdOperator，而没有在第8章中介绍的OLM机器。当您提供CSV和其他资产来为Operator创建OLM包时，OLM仍然使用它来代表您部署Operator。
  * 为了说明这一点，尽管您通常需要配置RBAC和一个服务帐户，但您可以使用一个命令将etcdOperator添加到Kubernetes斯集群中。这只是一种部署：
```shell
$ kubectl create -f https://raw.githubusercontent.com/\
 kubernetes-operators-book/chapters/master/ch03/
 etcd-operator-deployment.yaml
```

* Operator应该在集群上定义新的自定义资源类型。
  * 想想第二章中的etcd的例子。您创建了一个集群，并在其中定义了一种新的资源类型，即EtcdCRD。这类代表Operand的实例，由Operator管理的正在运行的etcd集群。用户通过创建该应用程序类型的新自定义资源来创建新的应用程序实例。
* Operator应尽可能使用适当的Kubernetes抽象概念。
  * 当API调用可以以更一致和更广泛测试的方式执行同样的事情时，不要编写新代码。一些非常有用的Operator只会以适合其应用程序的方式操作一些标准资源集。
* Operator终止不应影响Operand。
  * 当Operator停止或从集群中删除时，它管理的应用程序应该继续工作。返回到您的集群，并删除etcd或访客站点Operator。虽然您无法从故障故障中自动恢复，但在没有Operator的情况下，您仍然可以使用Operand的应用程序特性。您可以访问访问者站点或从etcd中检索键值对，即使各自的Operator没有运行
  
  请注意，删除一个CRD确实会影响Operand应用程序。事实上，删除一个CRD就会反过来删除它的CR实例。
* Operator应该了解任何以前的版本所创建的资源类型。
  * Operator应该与其前身的结构向后兼容。这需要仔细设计和简单，因为您在版本1中定义的资源必然会存在。
* Operator应协调应用程序的升级。
  * Operator应该协调其Operand的升级，可能包括跨应用程序集群的滚动升级，并且几乎肯定还包括在出现问题时回滚到以前版本的能力。保持软件的最新状态是必要的工作，因为只有最新的软件有最新的修复漏洞和安全漏洞。自动化这个升级工作是一个Operator的理想工作。
* 操作人员应进行彻底的测试，包括混沌测试。
  * 您的应用程序及其与基础设施的关系构成了一个复杂的分布式系统。你要信任你的Operator来管理这个系统。混沌测试(https://oreil.ly/K8IUR)故意导致系统组件的失败，从而发现意外的错误或降级。建立一个测试套件是一个很好的实践，它可以让Operator接受模拟错误和豆荚、节点和网络的直接出现，以查看组件之间的依赖项在其下面崩溃时出现故障或级联。


# 总结

Operator倾向于通过成熟的阶段，从自动安装到无缝应用程序升级，到稳定的“自动驾驶”状态，他们应对和纠正操作器的性能和稳定性问题。每个阶段都旨在结束更多的人类劳动。
让一个Operator来分发、部署和管理您的应用程序，使它更容易在Kubernetes上运行它，并允许应用程序利用库伯特特性。
遵循这里概述的七个习惯的Operator很容易部署，并且可以通过OLM对其生命周期进行管理。该Operator使其Operand能够运行、管理和潜在地实现。通过监控其应用程序的黄金信号，Operator可以做出明智的决定，将工程师从死操作任务中解放出来。
